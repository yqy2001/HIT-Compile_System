6.1 语法制导翻译概述

语义分析和中间代码生成一起做，叫做语义翻译。
语法分析和语义翻译一起做，叫做语法制导翻译。

![image-20210504151734992](https://i.loli.net/2021/05/04/upDNqwrC8kgmt1l.png)

既然是做语义翻译，那么如何表示语义信息？
为CFG中的文法符号设置**语义属性**，用来表示语法成分对应的语义信息，例如类型、值、地址。

如何计算语义属性？
语义属性值是用与文法符号所在**产生式**相关联的**语义规则**来计算的。
对于给定的输入串x，构建x的语法分析树，并利用与产生式相关联的语义规则来计算分析树中各结点对应的语义属性值

将语义规则和产生式联系起来要涉及两个概念：

* 语法制导定义SDD
* 语法制导翻译方案SDT

SDD：

SDD是对CFG的推广：

* 将每个文法符号和一个语义属性集合相关联
* 将每个产生式和一组语义规则相关联，这些规则用于计算该产生式中各文法符号的属性值

具体来说，若X是一个文法符号，a是X的一个属性，则用X.a表示属性a在某名称为X的分析树结点上的值。

SDD举例如下：

![image-20210504153441709](https://i.loli.net/2021/05/04/QluvbUCZSB4zJHf.png)

SDT：

SDT是在产生式右部嵌入了程序片段的CFG，这些程序片段称为语义动作。语义动作通常放在花括号内。语义动作在产生式中的位置决定了此动作的执行时间。

![image-20210504153908335](https://i.loli.net/2021/05/04/cV1UJqrNbesW6p3.png)

SDD与SDT：

![image-20210504154659882](https://i.loli.net/2021/05/04/2u3nHlfv9OigEYN.png)

6.2 语法制导定义

文法符号的属性分为综合属性和继承属性

综合属性：通过子节点或本身的属性值来定义的属性

继承属性：通过父节点或兄弟结点的属性值来定义的属性

**终结符**只有综合属性（由词法分析器提供的词法值），却**没有继承属性**。

一个没有副作用的SDD被称为属性文法。

**SDD的求值顺序：**

SDD为CFG中的文法符号设置语义属性。对于给定的输入串x，应用**语义规则**计算分析树中各结点对应的**属性值**。

计算属性值需要按照一定的顺序，语义规则建立了属性之间的依赖关系，在对语法分析树结点的一个属性求值之前，必须**先求出其依赖的所有属性值**。

依赖图是一个描述了分析树结点属性间依赖关系的有向图。若X.a依赖于Y.b，则图中存在一条从Y.b指向X.a的有向边。

举例如下，一个可行的属性值计算顺序是有向图的拓扑排序

![image-20210505162019533](https://i.loli.net/2021/05/05/5oq4A8G7aVRHJfT.png)

若SDD只具有综合属性，可以按照任何顺序自底向上计算它们的值。若既有综合属性又有继承属性，不一定存在一个顺序。

有环的图即无法找出一个拓扑排序：

![image-20210505162636140](https://i.loli.net/2021/05/05/ZYmSf74tpg2UxVn.png)

有两类SDD，可以保证对每棵语法分析树都存在一个求值顺序，分别是S-属性定义和L-属性定义，分别可以和自顶向下和自底向上的语法分析过程一起实现。

### S-属性定义与L-属性定义

S-属性定义：仅仅使用综合属性的SDD，可以按照任何自底向上的顺序来计算各个属性值，可以在自底向上的语法分析过程中实现。

L-属性定义：存在一个产生式$A→X_1X_2\dots X_n$，右部符号$X_i$的继承属性仅依赖于以下属性：

* A的继承属性
* $X_i$左边的符号$X_1X_2\dots X_i$的属性
* $X_i$本身的属性，但$X_i$的全部属性不能在依赖图中形成环路

L-属性定义对综合属性没有限制，要判断一个SDD是不是L-SDD，主要看其继承属性是否满足要求。每个S-属性定义都是L-属性定义。

子节点的继承属性只能依赖于父节点的**继承属性**，而不能是综合属性，因为父节点的综合属性会依赖子节点的继承属性，造成循环依赖。

![image-20210505172055479](https://i.loli.net/2021/05/05/5cqM9oD3adlWHZw.png)

L-SDD举例：

![image-20210505172127359](https://i.loli.net/2021/05/05/pZslc15DXBzr7TU.png)

6.4 语法制导翻译方案SDT

翻译模式是在产生式右部嵌入了程序片段(语义动作)的CFG

SDT可以看作是SDD的具体实施方案。主要实现两类重要的SDD，这两种情况的SDT可以在语法分析的过程中实现：

* 文法可以用LR分析法分析，SDD是S属性，自底向上
* 文法可以用LL分析法分析，SDD是L属性，自顶向下

S-SDD转换为SDT：直接将语义动作放在产生式的最后，归约发生时，执行相应的动作：

![image-20210505190133696](https://i.loli.net/2021/05/05/QyLN9sbfVm32wAE.png)

LR语法分析栈需要进行扩展，存放综合属性，并将语义动作改写成具体可执行的栈操作：

![image-20210505190408804](https://i.loli.net/2021/05/05/KFq3elPCUVWg7AR.png)

L-SDD转换为SDT：

将计算某个非终结符A的**继承属性**的动作插入到产生式右部中紧靠在A的**本次出现之前**的位置上。

将计算一个产生式左部符号的**综合属性**的动作放在这个产生式右部的**最右端**。举例如下：

<img src="https://i.loli.net/2021/05/05/t8lb7NATPy5YGma.png" alt="image-20210505193334476" style="zoom:67%;" />

如果一个L-SDD的基本文法可以使用LL分析技术，那么它的SDT可以在LL或LR语法分析中实现。

判断一个文法是否是LL文法，看相同左部的产生式。？

6.5 在非递归的预测分析过程中进行翻译

非终结符A的继承属性在它即将出现的时候计算，而综合属性得当其子节点都分析完毕后才能计算。

将A的继承属性和综合属性存放在不同的记录当中，**继承属性就存放在A的记录之中**，增加一个综合记录**Asyn来存放A的综合属性**。

Asyn在A之下，A之上还存放了一个指向语义动作代码的指针：

![image-20210508200508142](https://i.loli.net/2021/05/08/lJACkoqZrGjsBQE.png)

看PPT上在非递归的预测分析过程中进行翻译的例子

分析栈中的每一个记录都对应着一段执行代码：

* 综合记录出栈时，要将综合属性值复制给后面特定的语义动作
* 变量展开时（变量的记录出栈），若其含有**继承属性**，则要将继承属性值复制给后面特定的语义动作

一个SDT确定下来后，这个SDT中各个符号对应的执行代码就确定下来了

5-8 L属性定义的自底向上翻译

S-属性定义的SDT可以在自底向上的分析过程中实现翻译，因为其所有的语义动作都在产生式末尾，可以在归约时执行这些语义动作。

而L-属性定义，在产生式中间位置会嵌入一些语义动作，要实现自底向上的翻译，要先修改这个文法。

将产生式内部的所有语义动作替换为标记非终结符，增加一条标记非终结符的空产生式，语义动作用到的属性为非终结符的继承属性，语义动作生成的属性作为非终结符的综合属性。

空产生式中会用到产生式中没有的属性，但我们使用的是LR分析栈，这些属性已经存在于栈中的某个位置了：

![image-20210511080210389](https://i.loli.net/2021/05/11/5sE17fauD8z2vrJ.png)

终结符的继承属性位于终结符在栈中位置的下方

![image-20210511085928117](https://i.loli.net/2021/05/11/QlkvIegcJGCLshn.png)