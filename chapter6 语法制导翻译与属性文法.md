## 6.1 语法制导翻译概述

语义分析和中间代码生成一起做，叫做语义翻译。
语法分析和语义翻译一起做，叫做语法制导翻译。

<img src="chapter6 语法制导翻译与属性文法.assets/image-20210522085630146.png" alt="image-20210522085630146" style="zoom:50%;" />

既然是做语义翻译，那么如何表示语义信息？
为CFG中的文法符号设置**语义属性**，用来表示语法成分对应的语义信息，例如类型、值、地址。

如何计算语义属性？
语义属性值是用与文法符号所在**产生式**相关联的**语义规则**来计算的。
对于给定的输入串x，构建x的语法分析树，并利用与产生式相关联的语义规则来计算分析树中各结点对应的语义属性值

将语义规则和产生式联系起来要涉及两个概念：

* 语法制导定义SDD
* 语法制导翻译方案SDT

### SDD：

SDD是对CFG的推广：

* 将每个**文法符号**和一个**语义属性集合**相关联
* 将每个**产生式**和一组**语义规则**相关联，这些规则用于计算该产生式中各文法符号的属性值

具体来说，若X是一个文法符号，a是X的一个属性，则用X.a表示属性a在某名称为X的分析树结点上的值。

SDD举例如下：

<img src="https://i.loli.net/2021/05/04/QluvbUCZSB4zJHf.png" alt="image-20210504153441709" style="zoom:50%;" />

### SDT：

SDT是在产生式右部嵌入了程序片段的CFG，这些程序片段称为**语义动作**。语义动作放在花括号内。语义动作在产生式中的位置决定了此动作的执行时间。

<img src="https://i.loli.net/2021/05/04/cV1UJqrNbesW6p3.png" alt="image-20210504153908335" style="zoom:50%;" />

SDD与SDT：

<img src="https://i.loli.net/2021/05/04/2u3nHlfv9OigEYN.png" alt="image-20210504154659882" style="zoom:40%;" />

## 6.2 语法制导定义SDD

文法符号的属性分为综合属性和继承属性：

* 综合属性：通过**子节点或本身**的属性值来定义的属性
* 继承属性：通过**父或兄弟节点或本身**的属性值来定义的属性

**终结符**只有综合属性（由词法分析器提供的词法值），却**没有继承属性**。

一个没有副作用的SDD被称为属性文法。

注释分析树：每个结点都带有属性值的分析树，下面有图。

### SDD的求值顺序：

SDD为CFG中的文法符号设置语义属性。对于给定的输入串x，应用**语义规则**计算分析树中各结点对应的**属性值**。

计算属性值需要按照一定的顺序，语义规则建立了属性之间的依赖关系，在对语法分析树结点的一个属性求值之前，必须**先求出其依赖的所有属性值**。

依赖图是一个描述了分析树结点属性间依赖关系的有向图。若X.a依赖于Y.b，则图中存在一条从Y.b指向X.a的有向边。

举例如下，一个可行的属性值计算顺序是有向图的拓扑排序

![image-20210505162019533](https://i.loli.net/2021/05/05/5oq4A8G7aVRHJfT.png)

若SDD只具有综合属性，可以按照任何顺序自底向上计算它们的值。若既有综合属性又有继承属性，不一定存在一个顺序。

有环的图即无法找出一个拓扑排序：

![image-20210505162636140](https://i.loli.net/2021/05/05/ZYmSf74tpg2UxVn.png)

有两类SDD，可以保证对每棵语法分析树都存在一个求值顺序，分别是S-属性定义和L-属性定义，可以和自顶向下和自底向上的语法分析过程一起实现。

### S-属性定义与L-属性定义

S-属性定义：仅仅使用**综合属性**的SDD，可以按照任何自底向上的顺序来计算各个属性值，可以在自底向上的语法分析过程中实现。

L-属性定义：存在一个产生式$A→X_1X_2\dots X_n$，右部符号$X_i$的**继承属性**仅依赖于以下属性：

* A的**继承**属性
* $X_i$左边的符号$X_1X_2\dots X_i$的属性
* $X_i$本身的属性，但$X_i$的全部属性不能在依赖图中形成环路

直观来看就是依赖图的边可以从左向右，但不能从右向左。

L-属性定义对**综合属性**没有限制，要判断一个SDD是不是L-SDD，主要看其**继承属性**是否满足要求。每个S-属性定义都是L-属性定义。

子节点的继承属性只能依赖于父节点的**继承属性**，而不能是综合属性，因为父节点的综合属性会依赖子节点的继承属性，造成循环依赖。

![image-20210505172055479](https://i.loli.net/2021/05/05/5cqM9oD3adlWHZw.png)

L-SDD和非L-SDD举例：

<img src="https://i.loli.net/2021/05/05/pZslc15DXBzr7TU.png" alt="image-20210505172127359" style="zoom:40%;" /><img src="chapter6 语法制导翻译与属性文法.assets/image-20210522095311370.png" alt="image-20210522095311370" style="zoom:45%;" />

## 6.4 语法制导翻译方案SDT

翻译模式是在产生式右部嵌入了程序片段(语义动作)的CFG

SDT可以看作是SDD的具体实施方案。主要关注使用SDT来实现两类重要的SDD，这两种情况下，SDT可以在语法分析的过程中实现：

* 文法可以用LR分析法分析，SDD是S属性，自底向上
* 文法可以用LL分析法分析，SDD是L属性，自顶向下

S-SDD转换为SDT：直接将语义动作放在产生式的最后，归约发生时，执行相应的动作：

<img src="https://i.loli.net/2021/05/05/QyLN9sbfVm32wAE.png" alt="image-20210505190133696" style="zoom:50%;" />

若一个S-SDD的基本文法可以使用LR分析技术进行分析，则他的SDT可以在LR语法分析过程中实现。

LR语法分析栈需要进行扩展，存放综合属性（下图中的Value），并将语义动作改写成具体可执行的栈操作：

<img src="https://i.loli.net/2021/05/05/KFq3elPCUVWg7AR.png" alt="image-20210505190408804" style="zoom:50%;" />

### L-SDD转换为SDT：

将计算某个非终结符A的**继承属性**的动作插入到产生式右部中紧靠在A的**本次出现之前**的位置上。（因为计算A的继承属性需要的是左部的继承属性和左边符号的属性）

将计算一个产生式左部符号的**综合属性**的动作放在这个产生式右部的**最右端**。举例如下：

<img src="https://i.loli.net/2021/05/05/t8lb7NATPy5YGma.png" alt="image-20210505193334476" style="zoom: 50%;" />

如果一个L-SDD的基本文法可以使用LL分析技术，那么它的SDT可以在LL或LR语法分析中实现。

* 在非递归的预测分析过程中进行语义翻译
* 在递归的预测分析过程中进行语义翻译
* 在LR分析过程中进行语义翻译

判断一个文法是否是LL文法，看相同左部的产生式。？

## 6.5 在非递归的预测分析过程中进行翻译

非终结符A的继承属性在它**即将出现**的时候计算，而综合属性得当其子节点都分析完毕后才能计算。

将A的继承属性和综合属性存放在不同的记录当中，**继承属性就存放在和A处于相同位置的记录之中**，增加一个综合记录**Asyn来存放A的综合属性**。

Asyn在A之下，A之上还存放了一个指向语义动作代码的指针：

<img src="https://i.loli.net/2021/05/08/lJACkoqZrGjsBQE.png" alt="image-20210508200508142" style="zoom:50%;" />

例子：看PPT上在非递归的预测分析过程中进行翻译的例子。
终结符只有综合属性，综合属性值是由词法分析器提供的词法值
digit和3匹配，digit就可以出栈了，但由于语义动作a6需要使用digit的综合属性，所以digit出栈时，a6会缓存digit的综合属性
综合属性结点直接出栈，但将属性值缓存到需要使用的动作记录的域中
将已经有了继承属性的非终结符展开时，也要将其继承属性存储到需要用到此继承属性的语义动作中。

分析栈中的每一个记录都对应着一段执行代码：

* 综合记录出栈时，要将综合属性值复制给后面特定的语义动作
* 变量展开时（变量的记录出栈），若其含有**继承属性**，则要将继承属性值复制给后面特定的语义动作

一个SDT确定下来后，这个SDT中各个符号对应的执行代码就确定下来了

## 6.4 在递归的预测分析过程中进行翻译

为每个非终结符A构造一个函数，A的每个继承属性对应该函数的一个形参，函数的返回值是A的**综合属性**值。

为产生式右部符号的每个属性都设置一个局部变量

将语义动作代码复制到语法分析器，并将对属性的引用改为对相应变量的引用

## 5-8 L属性定义的自底向上翻译

S-属性定义的SDT可以在自底向上的分析过程中实现翻译，因为其所有的语义动作都在产生式末尾，可以在归约时执行这些语义动作。

而L-属性定义，在产生式中间位置会嵌入一些语义动作，要实现自底向上的翻译，要先修改这个文法。

将产生式内部的所有语义动作替换为标记非终结符，增加一条标记非终结符的空产生式，语义动作用到的属性为非终结符的继承属性，语义动作生成的属性作为非终结符的综合属性。

如果一个文法是LL的，其语义动作可以在产生式右部的任意位置，嵌入标记非终结符后得到的是**LR文法**。

空产生式中会用到产生式中没有的非终结符的属性，但我们使用的是LR分析栈，这些属性已经存在于栈中的某个位置了：

<img src="https://i.loli.net/2021/05/11/5sE17fauD8z2vrJ.png" alt="image-20210511080210389" style="zoom: 33%;" />

例子：见PPT，自己推一遍
注意：标记非终结符的综合属性其实算的就是下一个非终结符的继承属性。

将语义动作改写为可执行的栈操作：

<img src="chapter6 语法制导翻译与属性文法.assets/image-20210522201838419.png" alt="image-20210522201838419" style="zoom:50%;" />

终结符的继承属性位于终结符在栈中位置的下方：

<img src="https://i.loli.net/2021/05/11/QlkvIegcJGCLshn.png" alt="image-20210511085928117" style="zoom: 33%;" />